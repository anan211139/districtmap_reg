<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="utf-8" />
  <title>District Registration Map</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: "Kanit", sans-serif;
    }

    #map {
      height: 100vh;
    }

    #layout {
      display: flex;
      width: 100vw;
      height: 100vh;
    }

    /* map ‡∏Å‡∏¥‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ 90% */
    #map {
      flex: 0 0 90%;
      height: 100vh;
    }

    /* panel ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤ 10% */
    #side-panel {
      flex: 0 0 10%;
      min-width: 420px;
      /* ‡∏Å‡∏±‡∏ô‡πÅ‡∏Ñ‡∏ö‡πÄ‡∏Å‡∏¥‡∏ô */
      max-width: 520px;
      background: #f5f7fb;
      border-left: 1px solid #ddd;
    }

    /* table-panel ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á fixed ‡πÅ‡∏•‡πâ‡∏ß */
    #table-panel {
      position: relative;
      width: 100%;
      height: 100%;
      box-shadow: none;
    }

    .label-box {
      text-align: center;
      font-family: "Kanit", sans-serif;
      color: #000;
      text-shadow:
        -1px -1px 0 #fff,
        1px -1px 0 #fff,
        -1px 1px 0 #fff,
        1px 1px 0 #fff;
    }

    .label-name {
      font-size: 12px;
      font-weight: 600;
    }

    .label-value {
      font-size: 11px;
      font-weight: 700;
    }



    /* ===== label ===== */
    .district-label {
      pointer-events: none;
    }

    .label-box {
      text-align: center;
      white-space: nowrap;
      font-size: 12px;
      font-weight: 600;
      color: #000;
      text-shadow:
        -1px -1px 0 #fff,
        1px -1px 0 #fff,
        -1px 1px 0 #fff,
        1px 1px 0 #fff;
    }

    /* ===== overlay ===== */
    #overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .3);
      z-index: 1090;
    }

    .hidden {
      display: none;
    }

    /* ===== drawer ===== */
    #table-panel {
      position: fixed;
      top: 0;
      right: 0;
      width: 540px;
      height: 100vh;
      background: #fff;
      z-index: 1100;
      display: flex;
      flex-direction: column;
      box-shadow: -6px 0 20px rgba(0, 0, 0, .25);
    }

    /* ===== KPI ===== */
    #kpi-panel {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      padding: 12px;
      background: #fafbfe;
      border-bottom: 1px solid #ddd;
    }

    .kpi-card {
      background: #fff;
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, .1);
    }

    .kpi-title {
      font-size: 12px;
      color: #666;
    }

    .kpi-value {
      font-size: 20px;
      font-weight: 700;
      margin-top: 4px;
    }

    .kpi-sub {
      font-size: 11px;
      color: #888;
    }

    /* ===== header ===== */
    .table-header {
      display: flex;
      align-items: center;
      padding: 10px;
      background: #f5f7fb;
      border-bottom: 1px solid #ddd;
    }

    .tabs {
      display: flex;
    }

    .tab-btn {
      border: none;
      background: transparent;
      padding: 8px 12px;
      cursor: pointer;
    }

    .tab-btn.active {
      font-weight: 700;
      border-bottom: 2px solid #1976d2;
    }

    #close-table {
      margin-left: auto;
      font-size: 18px;
      border: none;
      background: transparent;
      cursor: pointer;
    }

    /* ===== content ===== */
    .tab-content {
      padding: 10px;
      overflow: auto;
      flex: 1;
    }

    .table-search {
      width: 100%;
      padding: 6px;
      margin-bottom: 6px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 6px;
    }

    th {
      background: #f0f3f9;
      cursor: pointer;
    }

    tbody tr:nth-child(even) {
      background: #fafafa;
    }

    th.sortable {
      cursor: pointer;
      position: relative;
      padding-right: 18px;
    }

    th.sortable::after {
      content: "‚áÖ";
      position: absolute;
      right: 6px;
      color: #999;
      font-size: 11px;
    }

    th.sortable.asc::after {
      content: "‚ñ≤";
      color: #1976d2;
    }

    th.sortable.desc::after {
      content: "‚ñº";
      color: #1976d2;
    }

    /* td {
      text-align: right;
    } */

    td:first-child {
      /* text-align: left; */
      font-weight: 600;
    }

    .group-row {
      background: #f2f5fb;
      font-weight: 600;
      cursor: pointer;
    }

    .detail-row {
      background: #fff;
    }

    .detail-row.hidden {
      display: none;
    }
  </style>
</head>

<body>


  <div id="layout">
    <div id="map"></div>
    <div id="side-panel">


      <!-- <div id="overlay"></div> -->

      <div id="table-panel">
        <!-- KPI -->
        <div id="kpi-panel">
          <div class="kpi-card">
            <div class="kpi-title">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            <div class="kpi-value" id="kpi-total"></div>
            <div class="kpi-sub">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô / ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-title" id="kpi-group1-title"></div>
            <div class="kpi-value" id="kpi-group1"></div>
            <div class="kpi-sub" id="kpi-group1-pct"></div>
          </div>
          <div class="kpi-card">
            <div class="kpi-title" id="kpi-group2-title"></div>
            <div class="kpi-value" id="kpi-group2"></div>
            <div class="kpi-sub" id="kpi-group2-pct"></div>
          </div>
        </div>
        <p style="padding-left: 20px;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 2 ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 2569 ‡πÄ‡∏ß‡∏•‡∏≤ 16.20 ‡∏ô.</p>
        <!-- tabs -->
        <div class="table-header">
          <div class="tabs">
            <button class="tab-btn active" data-tab="tab-district">‡πÄ‡∏Ç‡∏ï‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</button>
            <button class="tab-btn" data-tab="tab-group">‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡∏ï</button>
            <button class="tab-btn" data-tab="tab-constituency">‡πÄ‡∏Ç‡∏ï‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á</button>
          </div>
        </div>

        <!-- ‡πÄ‡∏Ç‡∏ï‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á -->
        <div id="tab-district" class="tab-content">
          <input class="table-search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï‡∏Å‡∏≤‡∏£‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á">
          <div class="table-wrap"></div>
        </div>

        <!-- ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡∏ï -->
        <div id="tab-group" class="tab-content hidden">
          <input class="table-search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡∏ï">
          <div class="table-wrap"></div>
        </div>

        <!-- ‡πÄ‡∏Ç‡∏ï‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á -->
        <div id="tab-constituency" class="tab-content hidden">
          <input class="table-search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á">
          <div class="table-wrap"></div>
        </div>





      </div>

    </div>
  </div>



  <script>

    // const DISTRICT_COLUMNS = [
    //   { key: 'district', label: '‡πÄ‡∏Ç‡∏ï' },

    //   { key: 'reg1', label: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (‡∏Å‡∏õ‡∏ô)' },
    //   { key: 'cap1', label: '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏Å‡∏õ‡∏ô)' },
    //   { key: 'pct1', label: '%' },

    //   { key: 'reg2', label: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (‡πÄ‡∏Ç‡∏ï)' },
    //   { key: 'cap2', label: '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏Ç‡∏ï)' },
    //   { key: 'pct2', label: '%' },

    //   { key: 'regT', label: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (‡∏£‡∏ß‡∏°)' },
    //   { key: 'capT', label: '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏£‡∏ß‡∏°)' },
    //   { key: 'pctT', label: '%' }
    // ];

    // ================= util =================
    const n = v => Number(v) || 0;

    // ================= columns =================

    const DISTRICT_GROUPS = [
      {
        key: 'bkk_center',
        label: '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Å‡∏•‡∏≤‡∏á',
        districts: ['‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£', '‡∏î‡∏∏‡∏™‡∏¥‡∏ï', '‡∏õ‡πâ‡∏≠‡∏°‡∏õ‡∏£‡∏≤‡∏ö‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡πà‡∏≤‡∏¢', '‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡∏ß‡∏á‡∏®‡πå', '‡∏î‡∏¥‡∏ô‡πÅ‡∏î‡∏á', '‡∏´‡πâ‡∏ß‡∏¢‡∏Ç‡∏ß‡∏≤‡∏á', '‡∏ß‡∏±‡∏á‡∏ó‡∏≠‡∏á‡∏´‡∏•‡∏≤‡∏á', '‡∏£‡∏≤‡∏ä‡πÄ‡∏ó‡∏ß‡∏µ', '‡∏û‡∏ç‡∏≤‡πÑ‡∏ó']
      },
      {
        key: 'bkk_north',
        label: '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡πÄ‡∏´‡∏ô‡∏∑‡∏≠',
        districts: ['‡∏à‡∏ï‡∏∏‡∏à‡∏±‡∏Å‡∏£', '‡∏•‡∏≤‡∏î‡∏û‡∏£‡πâ‡∏≤‡∏ß', '‡∏ö‡∏≤‡∏á‡∏ã‡∏∑‡πà‡∏≠', '‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏µ‡πà', '‡∏î‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á', '‡∏™‡∏≤‡∏¢‡πÑ‡∏´‡∏°', '‡∏ö‡∏≤‡∏á‡πÄ‡∏Ç‡∏ô']
      },
      {
        key: 'bkk_south',
        label: '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡πÉ‡∏ï‡πâ',
        districts: ['‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô', '‡∏ö‡∏≤‡∏á‡∏£‡∏±‡∏Å', '‡∏™‡∏≤‡∏ó‡∏£', '‡∏ö‡∏≤‡∏á‡∏Ñ‡∏≠‡πÅ‡∏´‡∏•‡∏°', '‡∏¢‡∏≤‡∏ô‡∏ô‡∏≤‡∏ß‡∏≤', '‡∏Ñ‡∏•‡∏≠‡∏á‡πÄ‡∏ï‡∏¢', '‡∏ß‡∏±‡∏í‡∏ô‡∏≤', '‡∏û‡∏£‡∏∞‡πÇ‡∏Ç‡∏ô‡∏á', '‡∏™‡∏ß‡∏ô‡∏´‡∏•‡∏ß‡∏á', '‡∏ö‡∏≤‡∏á‡∏ô‡∏≤']
      },
      {
        key: 'bkk_east',
        label: '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏ï‡∏∞‡∏ß‡∏±‡∏ô‡∏≠‡∏≠‡∏Å',
        districts: ['‡∏ö‡∏≤‡∏á‡∏Å‡∏∞‡∏õ‡∏¥', '‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏™‡∏π‡∏á', '‡∏ö‡∏∂‡∏á‡∏Å‡∏∏‡πà‡∏°', '‡∏Ñ‡∏±‡∏ô‡∏ô‡∏≤‡∏¢‡∏≤‡∏ß', '‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á', '‡∏°‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ', '‡∏´‡∏ô‡∏≠‡∏á‡∏à‡∏≠‡∏Å', '‡∏Ñ‡∏•‡∏≠‡∏á‡∏™‡∏≤‡∏°‡∏ß‡∏≤', '‡∏õ‡∏£‡∏∞‡πÄ‡∏ß‡∏®']
      },
      {
        key: 'thon_north',
        label: '‡∏Å‡∏£‡∏∏‡∏á‡∏ò‡∏ô‡πÄ‡∏´‡∏ô‡∏∑‡∏≠',
        districts: ['‡∏ò‡∏ô‡∏ö‡∏∏‡∏£‡∏µ', '‡∏Ñ‡∏•‡∏≠‡∏á‡∏™‡∏≤‡∏ô', '‡∏à‡∏≠‡∏°‡∏ó‡∏≠‡∏á', '‡∏ö‡∏≤‡∏á‡∏Å‡∏≠‡∏Å‡πÉ‡∏´‡∏ç‡πà', '‡∏ö‡∏≤‡∏á‡∏Å‡∏≠‡∏Å‡∏ô‡πâ‡∏≠‡∏¢', '‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏±‡∏î', '‡∏ï‡∏•‡∏¥‡πà‡∏á‡∏ä‡∏±‡∏ô', '‡∏ó‡∏ß‡∏µ‡∏ß‡∏±‡∏í‡∏ô‡∏≤']
      },
      {
        key: 'thon_south',
        label: '‡∏Å‡∏£‡∏∏‡∏á‡∏ò‡∏ô‡πÉ‡∏ï‡πâ',
        districts: ['‡∏†‡∏≤‡∏©‡∏µ‡πÄ‡∏à‡∏£‡∏¥‡∏ç', '‡∏ö‡∏≤‡∏á‡πÅ‡∏Ñ', '‡∏´‡∏ô‡∏≠‡∏á‡πÅ‡∏Ç‡∏°', '‡∏ö‡∏≤‡∏á‡∏Ç‡∏∏‡∏ô‡πÄ‡∏ó‡∏µ‡∏¢‡∏ô', '‡∏ö‡∏≤‡∏á‡∏ö‡∏≠‡∏ô', '‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ö‡∏π‡∏£‡∏ì‡∏∞', '‡∏ó‡∏∏‡πà‡∏á‡∏Ñ‡∏£‡∏∏']
      }
    ];

    function buildGroupData(data) {
      return DISTRICT_GROUPS.map(g => {
        const rows = data.filter(r => g.districts.includes(r.district));

        const reg = rows.reduce((s, r) => s + n(r.reg1) + n(r.reg2), 0);
        const cap = rows.reduce((s, r) => s + n(r.cap1) + n(r.cap2), 0);

        return {
          type: 'group',
          key: g.key,
          label: g.label,
          reg,
          cap,
          pct: cap ? reg / cap : 0,
          rows
        };
      });
    }



    const DISTRICT_COLUMNS = [
      { key: 'district', label: '‡πÄ‡∏Ç‡∏ï' },

      { key: 'reg1', label: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (‡∏Å‡∏õ‡∏ô)' },
      { key: 'cap1', label: '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏Å‡∏õ‡∏ô)' },
      {
        key: 'pct1',
        label: '% (‡∏´‡∏ô‡πà‡∏ß‡∏¢)',
        sortValue: r =>
          n(r.cap1) ? n(r.reg1) / n(r.cap1) : 0
      },

      { key: 'reg2', label: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (‡πÄ‡∏Ç‡∏ï)' },
      { key: 'cap2', label: '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÄ‡∏Ç‡∏ï)' },
      {
        key: 'pct2',
        label: '% (‡πÄ‡∏Ç‡∏ï)',
        sortValue: r =>
          n(r.cap2) ? n(r.reg2) / n(r.cap2) : 0
      },

      {
        key: 'regT',
        label: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (‡∏£‡∏ß‡∏°)',
        sortValue: r => n(r.reg1) + n(r.reg2)
      },
      {
        key: 'capT',
        label: '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏£‡∏ß‡∏°)',
        sortValue: r => n(r.cap1) + n(r.cap2)
      },
      {
        key: 'pctT',
        label: '% (‡∏£‡∏ß‡∏°)',
        sortValue: r => {
          const reg = n(r.reg1) + n(r.reg2);
          const cap = n(r.cap1) + n(r.cap2);
          return cap ? reg / cap : 0;
        }
      }
    ];



    const CONSTITUENCY_COLUMNS = [
      { key: 'constituency', label: '‡πÄ‡∏Ç‡∏ï‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á' },
      { key: 'detail', label: '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î' },

      { key: 'reg', label: '‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô' },
      { key: 'cap', label: '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' },
      { key: 'pct', label: '%' }
    ];
    function bgColor(p, alpha = 0.45) {
      const c = getColor(p); // ‡πÄ‡∏ä‡πà‡∏ô rgb(13,71,161)
      return c.replace('rgb(', 'rgba(').replace(')', `,${alpha})`);
    }


    /* ================= MAP ================= */
    const map = L.map('map').setView([13.75, 100.5], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const labelLayer = L.layerGroup().addTo(map);

    function featureArea(f) {
      return L.geoJSON(f).getBounds().getArea?.() || 0;
    }
    function renderLabels(geo) {
      labelLayer.clearLayers();

      const z = map.getZoom();

      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏Ç‡∏ï‡∏à‡∏≤‡∏Å‡πÉ‡∏´‡∏ç‡πà ‚Üí ‡πÄ‡∏•‡πá‡∏Å
      const features = [...geo.features].sort(
        (a, b) => featureArea(b) - featureArea(a)
      );

      features.forEach((f, i) => {
        const d = dataByDistrict[f.properties.district] || {
          reg1: 0, cap1: 0,
          reg2: 0, cap2: 0
        };

        const reg = d.reg1 + d.reg2;
        const cap = d.cap1 + d.cap2;

        const c = L.geoJSON(f).getBounds().getCenter();
        let html = '';

        // üîπ zoom 11‚Äì13 ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏Ç‡∏ï‡πÉ‡∏´‡∏ç‡πà ‡πÜ
        if (z >= 11 && z < 14) {
          if (i > 13) return; // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà ~13 ‡πÄ‡∏Ç‡∏ï
          html = `
        <div class="label-box">
          <div class="label-name">${f.properties.district}</div>
        </div>
      `;
        }

        // üîπ zoom 14 ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        if (z === 14) {
          if (i > 25) return;
          html = `
        <div class="label-box">
          <div class="label-name">${f.properties.district}</div>
          <div class="label-value">${reg} / ${cap}</div>
        </div>
      `;
        }

        // üîπ zoom ‚â•15 ‚Üí ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ç‡∏ï
        if (z >= 15) {
          html = `
        <div class="label-box">
          <div class="label-name">${f.properties.district}</div>
          <div class="label-value">${reg} / ${cap}</div>
        </div>
      `;
        }

        if (html) {
          labelLayer.addLayer(
            L.marker(c, {
              interactive: false,
              icon: L.divIcon({
                className: 'district-label',
                html
              })
            })
          );
        }
      });
    }



    // function renderLabels(geo) {
    //   labelLayer.clearLayers();

    //   geo.features.forEach(f => {
    //     const d = dataByDistrict[f.properties.district] || {
    //       reg1: 0, cap1: 0,
    //       reg2: 0, cap2: 0
    //     };

    //     const reg = d.reg1 + d.reg2;
    //     const cap = d.cap1 + d.cap2;

    //     const layer = L.geoJSON(f);
    //     const c = layer.getBounds().getCenter();

    //     let html = '';

    //     const z = map.getZoom();

    //     if (z >= 11 && z < 13) {
    //       // üîπ zoom ‡∏Å‡∏•‡∏≤‡∏á: ‡πÅ‡∏Ñ‡πà‡∏ä‡∏∑‡πà‡∏≠
    //       html = `
    //     <div class="label-box">
    //       <div class="label-name">${f.properties.district}</div>
    //     </div>
    //   `;
    //     }

    //     if (z >= 13) {
    //       // üîπ zoom ‡∏™‡∏π‡∏á: ‡∏ä‡∏∑‡πà‡∏≠ + ‡∏Ñ‡πà‡∏≤
    //       html = `
    //     <div class="label-box">
    //       <div class="label-name">${f.properties.district}</div>
    //       <div class="label-value">${reg} / ${cap}</div>
    //     </div>
    //   `;
    //     }

    //     if (html) {
    //       labelLayer.addLayer(
    //         L.marker(c, {
    //           interactive: false,
    //           icon: L.divIcon({
    //             className: 'district-label',
    //             html
    //           })
    //         })
    //       );
    //     }
    //   });
    // }


    // let geoCache = null;

    // function loadGeo() {
    //   fetch('district.geojson')
    //     .then(r => r.json())
    //     .then(geo => {
    //       geoCache = geo;

    //       L.geoJSON(geo, {
    //         style: f => {
    //           const d = dataByDistrict[f.properties.district] || { reg1: 0, cap1: 0, reg2: 0, cap2: 0 };
    //           const cap = d.cap1 + d.cap2;
    //           const p = cap === 0 ? 0 : (d.reg1 + d.reg2) / cap;
    //           return { fillColor: getColor(p), color: '#555', weight: 1, fillOpacity: .8 };
    //         },
    //         onEachFeature: (f, l) => {
    //           const d = dataByDistrict[f.properties.district] || { reg1: 0, cap1: 0, reg2: 0, cap2: 0 };
    //           const reg = d.reg1 + d.reg2;
    //           const cap = d.cap1 + d.cap2;
    //           const pct = cap ? ((reg / cap) * 100).toFixed(1) : 0;

    //           // ‚úÖ tooltip ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°
    //           l.bindTooltip(`
    //         <b>${f.properties.district}</b><br>
    //         ‡∏Å‡∏õ‡∏ô : ${d.reg1} / ${d.cap1}<br>
    //         ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà : ${d.reg2} / ${d.cap2}<br>
    //         <hr>
    //         ‡∏£‡∏ß‡∏° ${reg} / ${cap} (${pct}%)
    //       `, { sticky: true });
    //         }
    //       }).addTo(map);

    //       renderLabels(geo);
    //     });
    // }


    // map.on('zoomend', () => {
    //   if (geoCache) renderLabels(geoCache);
    // });

    /* ===== color ===== */
    function getColor(p) {
      p = Math.max(0, Math.min(1, p));
      const r = Math.round(227 + (13 - 227) * p);
      const g = Math.round(242 + (71 - 242) * p);
      const b = Math.round(253 + (161 - 253) * p);
      return `rgb(${r},${g},${b})`;
    }

    /* ===== helpers ===== */
    function sum(arr, key) { return arr.reduce((a, b) => a + (+b[key] || 0), 0); }
    function pct(a, b) { return b === 0 ? '0%' : ((a / b) * 100).toFixed(1) + '%'; }

    /* ================= DATA ================= */
    let dataCSV = [], conCSV = [], dataByDistrict = {};

    /* ----- load data.csv ----- */
    Papa.parse('data.csv', {
      download: true, header: true,
      complete: r => {
        dataCSV = r.data.filter(d => d.district);
        dataCSV.forEach(d => {
          dataByDistrict[d.district.trim()] = {
            reg1: +d.reg1, cap1: +d.cap1,
            reg2: +d.reg2, cap2: +d.cap2
          };
        });
        renderTable(dataCSV, 'tab-district', DISTRICT_COLUMNS);
        renderGroupTable(dataCSV, 'tab-group');
        updateKPIDataCSV();
        loadGeo();
      }
    });

    /* ----- load constituency ----- */
    Papa.parse('constituency_cleaned.csv', {
      download: true, header: true,
      complete: r => {
        conCSV = r.data.filter(d => d.constituency);
        renderTable(conCSV, 'tab-constituency', CONSTITUENCY_COLUMNS);
      }
    });

    /* ================= GEO ================= */
    function loadGeo() {
      fetch('district.geojson')
        .then(r => r.json())
        .then(geo => {
          labelLayer.clearLayers();

          L.geoJSON(geo, {
            style: f => {
              const d = dataByDistrict[f.properties.district] || {
                reg1: 0, cap1: 0,
                reg2: 0, cap2: 0
              };

              const capTotal = d.cap1 + d.cap2;
              const p = capTotal === 0 ? 0 : (d.reg1 + d.reg2) / capTotal;

              return {
                fillColor: getColor(p),
                color: '#555',
                weight: 1,
                fillOpacity: 0.8
              };
            },

            onEachFeature: (f, l) => {
              const d = dataByDistrict[f.properties.district] || {
                reg1: 0, cap1: 0,
                reg2: 0, cap2: 0
              };

              const regTotal = d.reg1 + d.reg2;
              const capTotal = d.cap1 + d.cap2;
              const pct = capTotal === 0
                ? 0
                : ((regTotal / capTotal) * 100).toFixed(1);

              /* ===== tooltip (‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£) ===== */
              l.bindTooltip(`
            <b>${f.properties.district}</b><br>
            ‡∏Å‡∏õ‡∏ô : ${d.reg1} / ${d.cap1}<br>
            ‡πÄ‡∏Ç‡∏ï : ${d.reg2} / ${d.cap2}<br>
            <hr>
            ‡∏£‡∏ß‡∏° ${regTotal} / ${capTotal} (${pct}%)
          `, {
                sticky: true,
                opacity: 0.95
              });

              /* ===== label ‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (‡∏¢‡∏±‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ===== */
              const c = l.getBounds().getCenter();
              labelLayer.addLayer(
                L.marker(c, {
                  interactive: false,
                  icon: L.divIcon({
                    className: 'district-label',
                    html: `
                  <div class="label-box">
                    <div class="label-name">${f.properties.district}</div>
                    <div class="label-value">${regTotal} / ${capTotal}</div>
                  </div>
                `
                  })
                })
              );
            }
          }).addTo(map);
        });
    }


    /* ================= KPI ================= */
    function updateKPIDataCSV() {
      const r1 = sum(dataCSV, 'reg1'), c1 = sum(dataCSV, 'cap1');
      const r2 = sum(dataCSV, 'reg2'), c2 = sum(dataCSV, 'cap2');
      document.getElementById('kpi-total').innerText = `${r1 + r2} / ${c1 + c2}`;
      document.getElementById('kpi-group1-title').innerText = '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢';
      document.getElementById('kpi-group1').innerText = `${r1} / ${c1}`;
      document.getElementById('kpi-group1-pct').innerText = pct(r1, c1);
      document.getElementById('kpi-group2-title').innerText = '‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏Ç‡∏ï';
      document.getElementById('kpi-group2').innerText = `${r2} / ${c2}`;
      document.getElementById('kpi-group2-pct').innerText = pct(r2, c2);
    }
    function updateKPICon() {
      const r = sum(conCSV, 'reg'), c = sum(conCSV, 'cap');
      document.getElementById('kpi-total').innerText = `${r} / ${c}`;
      document.getElementById('kpi-group1-title').innerText = '‡πÄ‡∏Ç‡∏ï‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á';
      document.getElementById('kpi-group1').innerText = `${r} / ${c}`;
      document.getElementById('kpi-group1-pct').innerText = pct(r, c);
      document.getElementById('kpi-group2-title').innerText = '';
      document.getElementById('kpi-group2').innerText = '';
      document.getElementById('kpi-group2-pct').innerText = '';
    }

    /* ================= TABLE ================= */
    function renderTable(data, tabId, columns) {
      const wrap = document.querySelector(`#${tabId} .table-wrap`);
      const search = document.querySelector(`#${tabId} .table-search`);

      let cur = [...data];
      let sortKey = null;
      let sortAsc = true;

      function draw(rows) {
        if (!rows.length) {
          wrap.innerHTML = '<i>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</i>';
          return;
        }

        let html = '<table><thead><tr>';

        columns.forEach(c => {
          html += `<th class="sortable" data-k="${c.key}">${c.label}</th>`;
        });

        html += '</tr></thead><tbody>';

        rows.forEach(r => {
          const pct1 = r.cap1 ? r.reg1 / r.cap1 : 0;
          const pct2 = r.cap2 ? r.reg2 / r.cap2 : 0;
          const regT = (+r.reg1 || 0) + (+r.reg2 || 0);
          const capT = (+r.cap1 || 0) + (+r.cap2 || 0);

          const pctT = capT ? regT / capT : 0;
          const pct = r.cap ? r.reg / r.cap : 0;

          html += '<tr>';

          columns.forEach(c => {
            let val = '';
            let style = '';

            switch (c.key) {
              case 'pct1':
                val = (pct1 * 100).toFixed(1) + '%';
                style = `style="background:${bgColor(pct1)}"`;
                break;

              case 'pct2':
                val = (pct2 * 100).toFixed(1) + '%';
                style = `style="background:${bgColor(pct2)}"`;
                break;

              case 'pctT':
                val = (pctT * 100).toFixed(1) + '%';
                style = `style="background:${bgColor(pctT)}"`;
                break;

              case 'pct':
                val = (pct * 100).toFixed(1) + '%';
                style = `style="background:${bgColor(pct)}"`;
                break;


              case 'regT':
                val = regT;
                break;
              case 'capT':
                val = capT;
                break;
              default:
                val = r[c.key] ?? '';
            }

            html += `<td ${style}>${val}</td>`;
          });

          html += '</tr>';
        });

        html += '</tbody></table>';
        wrap.innerHTML = html;

        /* ---- sort ---- */
        wrap.querySelectorAll('th.sortable').forEach(th => {
          th.onclick = () => {
            const k = th.dataset.k;
            sortAsc = (sortKey === k) ? !sortAsc : true;
            sortKey = k;

            wrap.querySelectorAll('th.sortable')
              .forEach(x => x.classList.remove('asc', 'desc'));
            th.classList.add(sortAsc ? 'asc' : 'desc');

            // cur.sort((a, b) => {
            //   const getVal = r => {
            //     if (k === 'pct1') return r.cap1 ? r.reg1 / r.cap1 : 0;
            //     if (k === 'pct2') return r.cap2 ? r.reg2 / r.cap2 : 0;
            //     if (k === 'pctT') {
            //       const rt = (r.reg1 || 0) + (r.reg2 || 0);
            //       const ct = (r.cap1 || 0) + (r.cap2 || 0);
            //       return ct ? rt / ct : 0;
            //     }
            //     if (k === 'pct') return r.cap ? r.reg / r.cap : 0;
            //     if (k === 'regT') return (r.reg1 || 0) + (r.reg2 || 0);
            //     if (k === 'capT') return (r.cap1 || 0) + (r.cap2 || 0);
            //     return r[k];
            //   };

            //   return (getVal(a) > getVal(b) ? 1 : -1) * (sortAsc ? 1 : -1);
            // });
            cur.sort((a, b) => {
              const col = DISTRICT_COLUMNS.find(c => c.key === k);
              console.log('sort key:', k, 'col:', col);

              let va, vb;

              if (col?.sortValue) {
                va = col.sortValue(a);
                vb = col.sortValue(b);
              } else {
                va = n(a[k]);
                vb = n(b[k]);
              }

              return (va > vb ? 1 : -1) * (sortAsc ? 1 : -1);
            });


            draw(cur);
          };
        });
      }

      /* ---- search ---- */
      search.oninput = () => {
        const q = search.value.toLowerCase();
        cur = data.filter(r =>
          Object.values(r).some(v =>
            String(v).toLowerCase().includes(q)
          )
        );
        draw(cur);
      };

      draw(cur);
    }
    //  summary ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏°
    function renderGroupTable(data, tabId) {
      const wrap = document.querySelector(`#${tabId} .table-wrap`);
      const search = document.querySelector(`#${tabId} .table-search`);

      let groups = buildGroupData(data);
      let cur = [...groups];

      let sortKey = null;
      let sortAsc = true;

      function draw(rows) {
        if (!rows.length) {
          wrap.innerHTML = '<i>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</i>';
          return;
        }

        let html = `
      <table>
        <thead>
          <tr>
            <th class="sortable" data-k="label">‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡∏ï</th>
            <th class="sortable" data-k="reg">‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</th>
            <th class="sortable" data-k="cap">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th>
            <th class="sortable" data-k="pct">%</th>
          </tr>
        </thead>
        <tbody>
    `;

        rows.forEach(g => {
          html += `
        <tr class="group-row" data-key="${g.key}">
          <td>‚ñ∂ ${g.label}</td>
          <td>${g.reg}</td>
          <td>${g.cap}</td>
          <td style="background:${bgColor(g.pct)}">
            ${(g.pct * 100).toFixed(1)}%
          </td>
        </tr>
      `;

          g.rows.forEach(r => {
            const reg = n(r.reg1) + n(r.reg2);
            const cap = n(r.cap1) + n(r.cap2);
            const pct = cap ? reg / cap : 0;

            html += `
          <tr class="detail-row hidden" data-parent="${g.key}">
            <td>&nbsp;&nbsp;‚Ü≥ ${r.district}</td>
            <td>${reg}</td>
            <td>${cap}</td>
            <td style="background:${bgColor(pct)}">
              ${(pct * 100).toFixed(1)}%
            </td>
          </tr>
        `;
          });
        });

        html += '</tbody></table>';
        wrap.innerHTML = html;

        // ===== expand / collapse =====
        wrap.querySelectorAll('.group-row').forEach(row => {
          row.onclick = () => {
            const key = row.dataset.key;
            wrap.querySelectorAll(`[data-parent="${key}"]`)
              .forEach(r => r.classList.toggle('hidden'));

            row.firstElementChild.textContent =
              row.firstElementChild.textContent.startsWith('‚ñ∂')
                ? row.firstElementChild.textContent.replace('‚ñ∂', '‚ñº')
                : row.firstElementChild.textContent.replace('‚ñº', '‚ñ∂');
          };
        });

        // ===== sort (group level only) =====
        wrap.querySelectorAll('th.sortable').forEach(th => {
          th.onclick = () => {
            const k = th.dataset.k;
            sortAsc = (sortKey === k) ? !sortAsc : true;
            sortKey = k;

            wrap.querySelectorAll('th.sortable')
              .forEach(x => x.classList.remove('asc', 'desc'));
            th.classList.add(sortAsc ? 'asc' : 'desc');

            cur.sort((a, b) => {
              let va = a[k];
              let vb = b[k];

              if (k === 'label') {
                va = a.label;
                vb = b.label;
              }

              return (va > vb ? 1 : -1) * (sortAsc ? 1 : -1);
            });

            draw(cur);
          };
        });
      }

      // ===== search =====
      if (search) {
        search.oninput = () => {
          const q = search.value.toLowerCase();

          cur = groups.filter(g =>
            g.label.toLowerCase().includes(q) ||
            g.rows.some(r =>
              r.district.toLowerCase().includes(q)
            )
          );

          draw(cur);
        };
      }

      draw(cur);
    }



    /* ================= TAB ================= */
    /* ================= TAB ================= */
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.onclick = () => {

        // active tab style
        document.querySelectorAll('.tab-btn')
          .forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // show / hide content
        document.querySelectorAll('.tab-content')
          .forEach(c => c.classList.add('hidden'));
        document.getElementById(btn.dataset.tab)
          .classList.remove('hidden');

        // update KPI + table ‡∏ï‡∏≤‡∏° tab
        switch (btn.dataset.tab) {

          case 'tab-district':
            updateKPIDataCSV();
            renderTable(dataCSV, 'tab-district', DISTRICT_COLUMNS);
            break;

          case 'tab-group':
            updateKPIDataCSV(); // ‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏Ç‡∏ï‡∏¢‡∏±‡∏á‡∏≠‡∏¥‡∏á dataCSV
            renderGroupTable(dataCSV, 'tab-group');
            break;

          case 'tab-constituency':
            updateKPICon();
            renderTable(conCSV, 'tab-constituency', CONSTITUENCY_COLUMNS);
            break;
        }
      };
    });


    // /* ================= CLOSE ================= */
    // document.getElementById('close-table').onclick=()=>{
    //   document.getElementById('table-panel').classList.add('hidden');
    //   document.getElementById('overlay').classList.add('hidden');
    // };

    setTimeout(() => {
      map.invalidateSize();
    }, 300);
  </script>
</body>

</html>